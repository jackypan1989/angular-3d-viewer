/**
 * Angular 3d Viewer
 * @version v0.0.1 - 2014-05-18
 * @link http://jackypan1989.github.com/angular-3d-viewer
 * @author Guan Yu Pan
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";angular.module("angular-3d-viewer",[]),angular.module("angular-3d-viewer").directive("viewer",function(a,b){return{restrict:"E",replace:!0,template:'<canvas id="mainCanvas"></canvas>',link:function(c){function d(){r=new THREE.Projector,q=new THREE.WebGLRenderer({canvas:n}),q.setSize(w,x),q.setClearColor(14540253),s=new THREE.Scene,e(),f(),g(),i(),h(),k(),j(),l()}function e(){t=new THREE.OrthographicCamera(-w/y,w/y,x/y,-x/y,-1e3,1e3),t.position.set(0,0,100),s.add(t)}function f(){u=new THREE.TrackballControls(t,n),u.addEventListener("change",m)}function g(){var a=10066329,b=new THREE.DirectionalLight(a);b.position.x=0,b.position.y=0,b.position.z=1,s.add(b),b=new THREE.DirectionalLight(a),b.position.x=0,b.position.y=0,b.position.z=-1,s.add(b),b=new THREE.DirectionalLight(a),b.position.x=0,b.position.y=1,b.position.z=0,s.add(b),b=new THREE.DirectionalLight(a),b.position.x=0,b.position.y=-1,b.position.z=0,s.add(b),b=new THREE.DirectionalLight(a),b.position.x=1,b.position.y=0,b.position.z=0,s.add(b),b=new THREE.DirectionalLight(a),b.position.x=-1,b.position.y=0,b.position.z=0,s.add(b)}function h(){v=new THREE.STLLoader,v.addEventListener("load",function(a){c.message="load model ..";var b=a.content;b.computeFaceNormals();var d;d="tooth"===a.info.type?new THREE.Mesh(b,new THREE.MeshLambertMaterial({overdraw:!0,color:16777215})):new THREE.Mesh(b,new THREE.MeshLambertMaterial({overdraw:!0,color:15766964})),d.info=a.info,d.position=new THREE.Vector3(0,0,0),0!==d.info.stage&&(d.visible=!1),o[d.info.stage].push(d),s.add(d)})}function i(){var a=new THREE.AxisHelper(1e3);a.position.set(0,0,0),s.add(a)}function j(){for(var a=0;a<c.step_num;a+=1){for(var b=1;16>=b;b+=1)v.load("./models/stage"+a+"-zip/Tooth_"+b+".stl",{stage:a,type:"tooth",location:"top"});for(var b=17;32>=b;b+=1)v.load("./models/stage"+a+"-zip/Tooth_"+b+".stl",{stage:a,type:"tooth",location:"btm"});v.load("./models/stage"+a+"-zip/Tooth_UpperJaw.stl",{stage:a,type:"jaw",location:"top"}),v.load("./models/stage"+a+"-zip/Tooth_LowerJaw.stl",{stage:a,type:"jaw",location:"btm"})}}function k(){a.get("data.json").then(function(a){c.data=a.data,c.$apply()})}function l(){if(c.rotate)for(var a=0;a<o.length;a++)for(var b=0;b<o[a].length;b++)o[a][b].rotation.y+=.01;requestAnimationFrame(l),u.update(),m()}function m(){q.render(s,t)}var n=document.getElementById("mainCanvas");c.step_anchor=0,c.step_num=4,c.data={},c.rotate=!1,c.message="Initialize canvas...",c.showTop=!0,c.showBtm=!0,c.showTeeth=!0,c.showJaw=!0,c.playStep=!1;for(var o=c.meshs=new Array(c.step_num),p=0;p<c.step_num;p+=1)o[p]=[];var q,r,s,t,u,v,w=1600,x=900,y=25;c.toggleTop=function(){c.showTop=!c.showTop,c.showStep(c.step_anchor)},c.toggleBtm=function(){c.showBtm=!c.showBtm,c.showStep(c.step_anchor)},c.toggleTeeth=function(){c.showTeeth=!c.showTeeth,c.showStep(c.step_anchor)},c.toggleJaw=function(){c.showJaw=!c.showJaw,c.showStep(c.step_anchor)},c.toggleSplit=function(){c.init();for(var a=0;a<o.length;a++)for(var b=0;b<o[a].length;b+=1)"btm"===o[a][b].info.location?o[a][b].position.set(0,0,0):(o[a][b].position.set(0,-5,-60),o[a][b].rotation.set(-Math.PI,0,0));u.reset(),t.left=-w/y*2,t.right=w/y*2,t.top=x/y*2+20,t.bottom=-x/y*2+20,console.log(t),t.position.y=400;var d=new THREE.Vector3(0,0,0);t.lookAt(d),t.updateProjectionMatrix()},c.viewFromTop=function(){c.init(),u.reset(),t.position.set(5,75,5);var a=new THREE.Vector3(0,0,0);t.lookAt(a)},c.viewFromBottom=function(){c.init(),t.position.set(5,-75,5);var a=new THREE.Vector3(0,0,0);t.lookAt(a)},c.viewFromFront=function(){c.init(),t.position.set(0,0,75);var a=new THREE.Vector3(0,0,0);t.lookAt(a)},c.viewFromBack=function(){c.init(),t.position.set(0,0,-75);var a=new THREE.Vector3(0,0,0);t.lookAt(a)},c.viewFromLeft=function(){c.init(),t.position.set(-75,0,0);var a=new THREE.Vector3(0,0,0);t.lookAt(a)},c.viewFromRight=function(){c.init(),t.position.set(75,0,0);var a=new THREE.Vector3(0,0,0);t.lookAt(a)},c.showStep=function(a){if(a!==c.step_anchor)for(var b=0;b<o[c.step_anchor].length;b++)o[c.step_anchor][b].visible=!1;for(var b=0;b<o[a].length;b++)o[a][b].visible=!1,c.showTop&&"top"===o[a][b].info.location?c.showTeeth&&"tooth"===o[a][b].info.type?o[a][b].visible=!0:c.showJaw&&"jaw"===o[a][b].info.type&&(o[a][b].visible=!0):c.showBtm&&"btm"===o[a][b].info.location&&(c.showTeeth&&"tooth"===o[a][b].info.type?o[a][b].visible=!0:c.showJaw&&"jaw"===o[a][b].info.type&&(o[a][b].visible=!0));c.step_anchor=a},c.nextStep=function(){c.step_anchor===c.step_num-1||c.showStep(c.step_anchor+1)},c.lastStep=function(){0===c.step_anchor||c.showStep(c.step_anchor-1)},c.init=function(){u.reset(),t.left=-w/y,t.right=w/y,t.top=x/y,t.bottom=-x/y,t.updateProjectionMatrix();for(var a=0;a<o.length;a++)for(var b=0;b<o[a].length;b++)o[a][b].position.set(0,0,0),o[a][b].rotation.set(0,0,0);c.showStep(0)},c.play=function(){c.playStep||(c.playStep=!0),c.step_anchor!==c.step_num-1?b(function(){c.nextStep(),c.play()},1e3):c.stop()},c.stop=function(){c.playStep=!1},d()}}});