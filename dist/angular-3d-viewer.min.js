/**
 * Angular 3d Viewer
 * @version v0.0.1 - 2014-05-14
 * @link http://jackypan1989.github.com/angular-3d-viewer
 * @author Guan Yu Pan
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";angular.module("angular-3d-viewer",[]),angular.module("angular-3d-viewer").directive("viewer",function(){return{restrict:"E",replace:!0,template:'<canvas id="mainCanvas"></canvas>',link:function(a){function b(){n=new THREE.WebGLRenderer({canvas:document.getElementById("mainCanvas")}),n.setSize(s,t),n.setClearColor(14540253),o=new THREE.Scene,c(),d(),e(),g(),f(),i(),j()}function c(){p=new THREE.PerspectiveCamera(75,s/t,1,1e4),p.position.set(0,0,100),o.add(p)}function d(){q=new THREE.TrackballControls(p,document.getElementById("mainCanvas")),q.addEventListener("change",k)}function e(){var a=15658734,b=new THREE.DirectionalLight(a);b.position.x=0,b.position.y=0,b.position.z=20,b.position.normalize(),o.add(b),b=new THREE.DirectionalLight(a),b.position.x=0,b.position.y=0,b.position.z=-20,o.add(b),b=new THREE.DirectionalLight(a),b.position.x=0,b.position.y=20,b.position.z=0,o.add(b),b=new THREE.DirectionalLight(a),b.position.x=0,b.position.y=-20,b.position.z=0,o.add(b)}function f(){r=new THREE.STLLoader,r.addEventListener("load",function(b){a.message="load model ..";var c=b.content;c.computeFaceNormals();var d;d="tooth"===b.info.type?new THREE.Mesh(c,new THREE.MeshLambertMaterial({overdraw:!0,color:16777215})):new THREE.Mesh(c,new THREE.MeshLambertMaterial({overdraw:!0,color:15766964})),d.info=b.info,d.position=new THREE.Vector3(0,0,0),0!==d.info.stage&&(d.visible=!1),l[d.info.stage].push(d),o.add(d)})}function g(){var a=1e3,b=new THREE.Object3D;b.add(h(new THREE.Vector3(0,0,0),new THREE.Vector3(a,0,0),16711680,!1)),b.add(h(new THREE.Vector3(0,0,0),new THREE.Vector3(-a,0,0),16711680,!0)),b.add(h(new THREE.Vector3(0,0,0),new THREE.Vector3(0,a,0),65280,!1)),b.add(h(new THREE.Vector3(0,0,0),new THREE.Vector3(0,-a,0),65280,!0)),b.add(h(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,a),255,!1)),b.add(h(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,-a),255,!0)),o.add(b)}function h(a,b,c,d){var e,f=new THREE.Geometry;e=d?new THREE.LineDashedMaterial({linewidth:3,color:c,dashSize:3,gapSize:3}):new THREE.LineBasicMaterial({linewidth:3,color:c}),f.vertices.push(a.clone()),f.vertices.push(b.clone()),f.computeLineDistances();var g=new THREE.Line(f,e,THREE.LinePieces);return g}function i(){for(var a=0;2>a;a+=1){for(var b=1;16>=b;b+=1)r.load("./models/example/stage"+a+"/Tooth_"+b+".stl",{stage:a,type:"tooth",location:"top"});for(var b=17;32>=b;b+=1)r.load("./models/example/stage"+a+"/Tooth_"+b+".stl",{stage:a,type:"tooth",location:"btm"});r.load("./models/example/stage"+a+"/Tooth_UpperJaw.stl",{stage:a,type:"jaw",location:"top"}),r.load("./models/example/stage"+a+"/Tooth_LowerJaw.stl",{stage:a,type:"jaw",location:"btm"})}}function j(){if(u)for(var a=0;a<l.length;a++)for(var b=0;b<l[a].length;b++)l[a][b].rotation.y+=.01;requestAnimationFrame(j),q.update(),k()}function k(){n.render(o,p)}a.step_anchor=0,a.step_num=2,a.message="Initialize canvas...";for(var l=a.meshs=new Array(a.step_num),m=0;m<a.step_num;m+=1)l[m]=[];var n,o,p,q,r,s=720,t=540,u=!1;a.toggleTop=function(){for(var b=0;b<l[a.step_anchor].length;b++)"top"===l[a.step_anchor][b].info.location&&(l[a.step_anchor][b].visible=!l[a.step_anchor][b].visible)},a.toggleBtm=function(){for(var b=0;b<l[a.step_anchor].length;b++)"btm"===l[a.step_anchor][b].info.location&&(l[a.step_anchor][b].visible=!l[a.step_anchor][b].visible)},a.viewFromTop=function(){a.init(),p.position.set(0,100,0);var b=new THREE.Vector3(0,0,0);p.lookAt(b)},a.viewFromBottom=function(){a.init(),p.position.set(0,-100,0);var b=new THREE.Vector3(0,0,0);p.lookAt(b)},a.viewFromFront=function(){a.init(),p.position.set(0,0,100);var b=new THREE.Vector3(0,0,0);p.lookAt(b)},a.viewFromBack=function(){a.init(),p.position.set(0,0,-100);var b=new THREE.Vector3(0,0,0);p.lookAt(b)},a.viewFromLeft=function(){a.init(),p.position.set(-100,0,0);var b=new THREE.Vector3(0,0,0);p.lookAt(b)},a.viewFromRight=function(){a.init(),p.position.set(100,0,0);var b=new THREE.Vector3(0,0,0);p.lookAt(b)},a.showStep=function(b){for(var c=0;c<l[a.step_anchor].length;c++)l[a.step_anchor][c].visible=!1;for(var c=0;c<l[b].length;c++)l[b][c].visible=!0;a.step_anchor=b},a.nextStep=function(){a.showStep(a.step_anchor===a.step_num-1?0:a.step_anchor+1)},a.lastStep=function(){a.showStep(0===a.step_anchor?a.step_num-1:a.step_anchor-1)},a.init=function(){a.stop(),q.reset();for(var b=0;b<l.length;b++)for(var c=0;c<l[b].length;c++)l[b][c].position=new THREE.Vector3(0,0,0),l[b][c].rotation.x=0,l[b][c].rotation.y=0,l[b][c].rotation.z=0},a.play=function(){u=!0},a.stop=function(){u=!1},b()}}});