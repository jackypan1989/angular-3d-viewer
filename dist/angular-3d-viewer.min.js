/**
 * Angular 3d Viewer
 * @version v0.0.1 - 2014-05-16
 * @link http://jackypan1989.github.com/angular-3d-viewer
 * @author Guan Yu Pan
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";angular.module("angular-3d-viewer",[]),angular.module("angular-3d-viewer").directive("viewer",function(a){return{restrict:"E",replace:!0,template:'<canvas id="mainCanvas"></canvas>',link:function(b){function c(){p=new THREE.WebGLRenderer({canvas:document.getElementById("mainCanvas")}),p.setSize(u,v),p.setClearColor(14540253),q=new THREE.Scene,d(),e(),f(),h(),g(),k(),j(),l()}function d(){r=new THREE.OrthographicCamera(u/-10,u/10,v/10,v/-10,1,1e3),r.position.set(0,0,75),q.add(r)}function e(){s=new THREE.TrackballControls(r,document.getElementById("mainCanvas")),s.addEventListener("change",m)}function f(){var a=13421772,b=new THREE.DirectionalLight(a);b.position.x=0,b.position.y=0,b.position.z=1,q.add(b),b=new THREE.DirectionalLight(a),b.position.x=0,b.position.y=0,b.position.z=-1,q.add(b),b=new THREE.DirectionalLight(a),b.position.x=0,b.position.y=1,b.position.z=0,q.add(b),b=new THREE.DirectionalLight(a),b.position.x=0,b.position.y=-1,b.position.z=0,q.add(b)}function g(){t=new THREE.STLLoader,t.addEventListener("load",function(a){b.message="load model ..";var c=a.content;c.computeFaceNormals();var d;d="tooth"===a.info.type?new THREE.Mesh(c,new THREE.MeshLambertMaterial({overdraw:!0,color:16777215})):new THREE.Mesh(c,new THREE.MeshLambertMaterial({overdraw:!0,color:15766964})),d.info=a.info,d.position=new THREE.Vector3(0,0,0),0!==d.info.stage&&(d.visible=!1),n[d.info.stage].push(d),q.add(d)})}function h(){var a=1e3,b=new THREE.Object3D;b.add(i(new THREE.Vector3(0,0,0),new THREE.Vector3(a,0,0),16711680,!1)),b.add(i(new THREE.Vector3(0,0,0),new THREE.Vector3(-a,0,0),16711680,!0)),b.add(i(new THREE.Vector3(0,0,0),new THREE.Vector3(0,a,0),65280,!1)),b.add(i(new THREE.Vector3(0,0,0),new THREE.Vector3(0,-a,0),65280,!0)),b.add(i(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,a),255,!1)),b.add(i(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,-a),255,!0)),q.add(b)}function i(a,b,c,d){var e,f=new THREE.Geometry;e=d?new THREE.LineDashedMaterial({linewidth:3,color:c,dashSize:3,gapSize:3}):new THREE.LineBasicMaterial({linewidth:3,color:c}),f.vertices.push(a.clone()),f.vertices.push(b.clone()),f.computeLineDistances();var g=new THREE.Line(f,e,THREE.LinePieces);return g}function j(){for(var a=0;4>a;a+=1){for(var b=1;16>=b;b+=1)t.load("./models/example/stage"+a+"-zip/Tooth_"+b+".stl",{stage:a,type:"tooth",location:"top"});for(var b=17;32>=b;b+=1)t.load("./models/example/stage"+a+"-zip/Tooth_"+b+".stl",{stage:a,type:"tooth",location:"btm"});t.load("./models/example/stage"+a+"-zip/Tooth_UpperJaw.stl",{stage:a,type:"jaw",location:"top"}),t.load("./models/example/stage"+a+"-zip/Tooth_LowerJaw.stl",{stage:a,type:"jaw",location:"btm"})}}function k(){a.get("data.json").then(function(a){b.data=a.data,b.$apply()})}function l(){if(b.rotate)for(var a=0;a<n.length;a++)for(var c=0;c<n[a].length;c++)n[a][c].rotation.y+=.01;requestAnimationFrame(l),s.update(),m()}function m(){p.render(q,r)}b.step_anchor=0,b.step_num=4,b.data={},b.rotate=!1,b.message="Initialize canvas...",b.showTop=!0,b.showBtm=!0,b.showTooth=!0,b.showJaw=!0;for(var n=b.meshs=new Array(b.step_num),o=0;o<b.step_num;o+=1)n[o]=[];var p,q,r,s,t,u=720,v=540;b.toggleTop=function(){for(var a=0;a<n[b.step_anchor].length;a++)"top"===n[b.step_anchor][a].info.location&&(n[b.step_anchor][a].visible=!n[b.step_anchor][a].visible)},b.toggleBtm=function(){for(var a=0;a<n[b.step_anchor].length;a++)"btm"===n[b.step_anchor][a].info.location&&(n[b.step_anchor][a].visible=!n[b.step_anchor][a].visible)},b.viewFromTop=function(){b.init(),r.position.set(1,75,0);var a=new THREE.Vector3(0,0,0);r.lookAt(a)},b.viewFromBottom=function(){b.init(),r.position.set(0,-75,0);var a=new THREE.Vector3(0,0,0);r.lookAt(a)},b.viewFromFront=function(){b.init(),r.position.set(0,0,75);var a=new THREE.Vector3(0,0,0);r.lookAt(a)},b.viewFromBack=function(){b.init(),r.position.set(0,0,-75);var a=new THREE.Vector3(0,0,0);r.lookAt(a)},b.viewFromLeft=function(){b.init(),r.position.set(-75,0,0);var a=new THREE.Vector3(0,0,0);r.lookAt(a)},b.viewFromRight=function(){b.init(),r.position.set(75,0,0);var a=new THREE.Vector3(0,0,0);r.lookAt(a)},b.showStep=function(a){for(var c=0;c<n[b.step_anchor].length;c++)n[b.step_anchor][c].visible=!1;for(var c=0;c<n[a].length;c++)n[a][c].visible=!0;b.step_anchor=a},b.nextStep=function(){b.showStep(b.step_anchor===b.step_num-1?0:b.step_anchor+1)},b.lastStep=function(){b.showStep(0===b.step_anchor?b.step_num-1:b.step_anchor-1)},b.init=function(){b.stop(),s.reset();for(var a=0;a<n.length;a++)for(var c=0;c<n[a].length;c++)n[a][c].position=new THREE.Vector3(0,0,0),n[a][c].rotation.x=0,n[a][c].rotation.y=0,n[a][c].rotation.z=0},b.play=function(){b.rotate=!0},b.stop=function(){b.rotate=!1},c()}}});